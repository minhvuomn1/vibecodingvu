name: Build and Test Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Install Salesforce CLI
      run: |
        npm install -g @salesforce/cli

    - name: Authenticate to Salesforce Org
      run: |
        sf org login jwt --username ${{ secrets.SALESFORCE_USERNAME }} \
          --client-id ${{ secrets.SALESFORCE_CLIENT_ID }} \
          --client-secret ${{ secrets.SALESFORCE_CLIENT_SECRET }} \
          --jwt-key-file ${{ secrets.SALESFORCE_JWT_KEY }} \
          --alias prod-org

    - name: Run Apex Tests
      run: |
        sf apex test run -r human -w 10 -o prod-org
